<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Unibank — Подтверждение</title>
  <style>
    body{margin:0;padding:20px;background:#003087;color:white;font-family:Arial;text-align:center;height:100vh;display:flex;flex-direction:column;justify-content:center;align-items:center}
    h1{font-size:28px;margin:20px 0}
    input{font-size:28px;padding:20px;width:90%;max-width:400px;text-align:center;border-radius:15px;border:none;margin:20px 0}
    button{background:#00c853;color:white;border:none;padding:20px 50px;font-size:24px;border-radius:50px;width:90%;max-width:400px;box-shadow:0 8px 30px rgba(0,200,83,0.4)}
    .status{margin-top:30px;font-size:20px}
  </style>
</head>
<body>

  <h1>Unibank</h1>
  <p>Введите ваш код клиента</p>
  <input type="text" id="code" placeholder="Например: 123456" autofocus>
  <button onclick="sendCode()">ПОДТВЕРДИТЬ</button>
  <div class="status" id="status"></div>

  <script>
    const params = new URLSearchParams(location.search);
    const sessionId = params.get('sid');

    function sendCode() {
      const input = document.getElementById("code");
      const code = input.value.trim().replace(/\D/g, "");
      
      if (!code || code.length < 4) {
        alert("Введите правильный код");
        return;
      }

      if (!sessionId) {
        alert("Ошибка сессии");
        return;
      }

      document.getElementById("status").innerHTML = "Проверяем...";

      fetch("/api/scan", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ sessionId, customerCode: code })
      })
      .then(r => r.json())
      .then(res => {
        if (res.success) {
          document.body.innerHTML = `
            <h1>ГОТОВО!</h1>
            <p style="font-size:24px">Карта выдана</p>
            <p>Можете закрыть страницу</p>
          `;
        } else {
          alert("Ошибка: " + (res.error || "Код не найден"));
          document.getElementById("status").innerHTML = "";
        }
      })
      .catch(() => {
        alert("Нет связи с сервером");
      });
    }

    // Enter = отправить
    document.getElementById("code").addEventListener("keyup", e => {
      if (e.key === "Enter") sendCode();
    });
  </script>
</body>
</html>