<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Сканер</title>
  <style>
    body,html{margin:0;padding:0;height:100%;background:#000;color:#fff;overflow:hidden;text-align:center}
    #start{display:flex;flex-direction:column;justify-content:center;align-items:center;height:100%;background:#111}
    button{background:#34A853;color:#fff;border:none;padding:25px 60px;font-size:30px;border-radius:25px;cursor:pointer}
    #video{display:none;width:100vw;height:100vh;object-fit:cover}
    .frame{position:fixed;top:50%;left:50%;width:320px;height:320px;transform:translate(-50%,-50%);border:6px solid #4CAF50;border-radius:25px;pointer-events:none;z-index:10}
    #input{position:fixed;bottom:40px;left:50%;transform:translateX(-50%);width:90%;background:rgba(0,0,0,0.9);padding:25px;border-radius:25px;display:none}
    input,button{width:100%;padding:20px;font-size:26px;margin:12px 0;border:none;border-radius:18px}
    input{background:#fff;color:#000}
    button{background:#34A853;color:#fff;font-weight:bold}
  </style>
</head>
<body>
  <div id="start">
    <h1>Сканирование</h1>
    <button onclick="go()">ОТКРЫТЬ КАМЕРУ</button>
  </div>

  <video id="video" playsinline muted></video>
  <div class="frame"></div>

  <div id="input">
    <input type="text" id="code" placeholder="Введите код клиента" autofocus>
    <button onclick="send()">ОТПРАВИТЬ</button>
  </div>

  <script src="https://unpkg.com/jsqr@1.4.0/dist/jsQR.js"></script>
  <script>
    let sessionId = null;
    const video = document.getElementById('video');

    async function go() {
      const stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
      document.getElementById("start").style.display="none";
      video.style.display="block";
      video.srcObject = stream;
      video.play();
      requestAnimationFrame(tick);
    }

    function tick() {
      if (video.readyState === video.HAVE_ENOUGH_DATA) {
        const canvas = document.createElement("canvas");
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(video, 0, 0);
        const code = jsQR(ctx.getImageData(0, 0, canvas.width, canvas.height).data, canvas.width, canvas.height);
        if (code && code.data) {
          try {
            const d = JSON.parse(code.data);
            if (d.sessionId) {
              sessionId = d.sessionId;
              document.getElementById("input").style.display = "block";
              document.getElementById("code").focus();
            }
          } catch(e) {}
        }
      }
      requestAnimationFrame(tick);
    }

    async function send() {
      const code = document.getElementById("code").value.trim().replace(/\D/g,"");
      if (!code) return alert("Введите код");

      const r = await fetch("/api/scan", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({sessionId, customerCode:code})
      });
      const j = await r.json();

      if (j.success) {
        document.body.innerHTML = `<div style="padding:60px;font-size:34px">
          <h1 style="color:#0f0">ГОТОВО!</h1>
          ${j.data.first_name} ${j.data.last_name}<br>
          Карта: ${j.data.card_number ? j.data.card_number.replace(/(.{4})/g,"$1 ").trim() : "не привязана"}<br><br>
          <span style="color:#0f0">Данные отправлены на кассу!</span>
        </div>`;
      } else {
        alert("Ошибка: " + (j.error || "не найден"));
      }
    }

    document.addEventListener("keypress", e => {
      if (e.key==="Enter" && document.getElementById("input").style.display==="block") send();
    });
  </script>
</body>
</html>