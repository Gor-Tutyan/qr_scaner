<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Unibank — Подтверждение</title>
  <style>
    body{margin:0;padding:20px;background:#003087;color:#fff;font-family:Arial;text-align:center;height:100vh;display:flex;flex-direction:column;justify-content:flex-start;align-items:center}
    h1{font-size:28px;margin:30px 0 10px}
    p{font-size:18px;opacity:0.9}
    .scanner{width:300px;height:300px;border:4px dashed #fff;border-radius:20px;margin:20px auto;background:rgba(255,255,255,0.1)}
    input{font-size:28px;padding:16px;width:90%;max-width:400px;border:none;border-radius:15px;text-align:center;margin:15px 0}
    button{background:#00c853;color:white;border:none;padding:18px;font-size:22px;border-radius:50px;width:90%;max-width:400px;margin:10px 0;cursor:pointer}
    .or{margin:20px 0;font-size:18px;opacity:0.8}
  </style>
</head>
<body>

  <h1>Unibank</h1>
  <p>Отсканируйте или введите код клиента</p>

  <div class="scanner" id="reader"></div>

  <div class="or">— ИЛИ —</div>

  <input type="text" id="manualCode" placeholder="Введите код вручную" autofocus>
  <button onclick="sendCode()">ПОДТВЕРДИТЬ</button>

  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <script>
    // Читаем sid ИЗ QR-КОДА (теперь точно не будет "устарела")
    const urlParams = new URLSearchParams(location.search);
    const sessionId = urlParams.get('sid');

    if (!sessionId) {
      document.body.innerHTML = "<h2 style='margin-top:100px'>Ссылка устарела или повреждена</h2>";
    }

    function sendToServer(code) {
      if (!code || code.length < 4) return alert("Код слишком короткий");

      fetch("/api/scan", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ sessionId, customerCode: code })
      })
      .then(r => r.json())
      .then(res => {
        if (res.success) {
          document.body.innerHTML = `<h1>ГОТОВО!</h1><p style="font-size:24px">Карта успешно выдана</p>`;
        } else {
          alert("Ошибка: " + (res.error || "Код не найден"));
        }
      })
      .catch(() => alert("Нет связи с сервером"));
    }

    // Сканер
    function startScanner() {
      const scanner = new Html5Qrcode("reader");
      scanner.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: { width: 250, height: 250 } },
        (text) => {
          const code = text.replace(/\D/g, '');
          if (code.length >= 4) {
            sendToServer(code);
            scanner.stop();
          }
        },
        () => {}
      ).catch(() => {
        // Если камера не работает — просто оставляем поле ввода
        console.log("Камера недоступна");
      });
    }

    // Ручной ввод
    window.sendCode = function() {
      const code = document.getElementById("manualCode").value.replace(/\D/g, "");
      sendToServer(code);
    };

    // Автозапуск сканера на телефоне
    if (/Android|iPhone|iPad/i.test(navigator.userAgent)) {
      setTimeout(startScanner, 1000);
    }

    // Enter в поле = отправить
    document.getElementById("manualCode").addEventListener("keyup", e => {
      if (e.key === "Enter") sendCode();
    });
  </script>
</body>
</html>