<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Unibank — Подтверждение</title>
  <style>
    body{margin:0;padding:20px;background:#003087;color:white;font-family:Arial;text-align:center;height:100vh;display:flex;flex-direction:column;justify-content:flex-start;align-items:center}
    h1{font-size:28px;margin:30px 0 10px}
    p{font-size:18px;opacity:0.9}
    .scanner{border:4px dashed #fff;border-radius:20px;width:300px;height:300px;margin:20px auto;background:rgba(255,255,255,0.1)}
    input{font-size:28px;padding:16px;width:90%;max-width:400px;border:none;border-radius:15px;text-align:center;margin:15px 0}
    button{background:#00c853;color:white;border:none;padding:18px;font-size:22px;border-radius:50px;width:90%;max-width:400px;margin:10px 0;box-shadow:0 8px 30px rgba(0,200,83,0.4);cursor:pointer}
    .or{margin:20px 0;font-size:18px;opacity:0.8}
  </style>
</head>
<body>

  <h1>Unibank</h1>
  <p>Отсканируйте или введите код клиента</p>

  <div class="scanner" id="reader"></div>

  <div class="or">— ИЛИ —</div>

  <input type="text" id="manualCode" placeholder="Введите код вручную" autofocus>
  <button onclick="sendCode()">ПОДТВЕРДИТЬ</button>

  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <script>
    const params = new URLSearchParams(location.search);
    const sessionId = params.get('sid');

    if (!sessionId) {
      document.body.innerHTML = "<h2>Ошибка: ссылка устарела</h2>";
    }

    // Автозапуск сканера
    function startScanner() {
      const html5QrCode = new Html5Qrcode("reader");
      html5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: { width: 250, height: 250 } },
        (decodedText) => {
          const code = decodedText.replace(/\D/g, '');
          if (code.length >= 4) {
            sendToServer(code);
            html5QrCode.stop();
          }
        },
        () => {}
      ).catch(err => {
        console.log("Камера недоступна, но можно ввести вручную");
      });
    }

    function sendToServer(code) {
      fetch("/api/scan", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ sessionId, customerCode: code })
      })
      .then(r => r.json())
      .then(res => {
        if (res.success) {
          document.body.innerHTML = `<h1>ГОТОВО!</h1><p style="font-size:24px">Карта выдана</p>`;
        } else {
          alert("Ошибка: " + (res.error || "Код не найден"));
        }
      })
      .catch(() => alert("Нет связи"));
    }

    function sendCode() {
      const code = document.getElementById("manualCode").value.replace(/\D/g, "");
      if (code.length >= 4) sendToServer(code);
      else alert("Введите корректный код");
    }

    // Автозапуск сканера на телефоне
    if (/Android|iPhone|iPad/i.test(navigator.userAgent)) {
      setTimeout(startScanner, 800);
    }

    // Enter в поле ввода = отправить
    document.getElementById("manualCode").addEventListener("keyup", e => {
      if (e.key === "Enter") sendCode();
    });
  </script>
</body>
</html>